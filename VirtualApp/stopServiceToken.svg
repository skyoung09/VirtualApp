<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="691px" preserveAspectRatio="none" style="width:1238px;height:691px;" version="1.1" viewBox="0 0 1238 691" width="1238px" zoomAndPan="magnify"><defs><filter height="300%" id="fz5vky1xtqs6e" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#FFB6C1" height="686.877" style="stroke: #A80036; stroke-width: 1.0;" width="831" x="52" y="4"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="94" x="420.5" y="16.5684">Client Process</text><rect fill="#90EE90" height="686.877" style="stroke: #A80036; stroke-width: 1.0;" width="192" x="885" y="4"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="932" y="16.5684">Server Process</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="126" x2="126" y1="58.7988" y2="652.3887"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="278" x2="278" y1="58.7988" y2="652.3887"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="419" x2="419" y1="58.7988" y2="652.3887"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="555" x2="555" y1="58.7988" y2="652.3887"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="666" x2="666" y1="58.7988" y2="652.3887"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="794" x2="794" y1="58.7988" y2="652.3887"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="981" x2="981" y1="58.7988" y2="652.3887"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1176" x2="1176" y1="58.7988" y2="652.3887"/><rect fill="#FEFECE" filter="url(#fz5vky1xtqs6e)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="136" x="56" y="23.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="122" x="63" y="43.8457">StopServiceToken</text><rect fill="#FEFECE" filter="url(#fz5vky1xtqs6e)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="136" x="56" y="651.3887"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="122" x="63" y="671.9238">StopServiceToken</text><rect fill="#FEFECE" filter="url(#fz5vky1xtqs6e)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="141" x="206" y="23.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="127" x="213" y="43.8457">ApplicationThread</text><rect fill="#FEFECE" filter="url(#fz5vky1xtqs6e)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="141" x="206" y="651.3887"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="127" x="213" y="671.9238">ApplicationThread</text><rect fill="#FEFECE" filter="url(#fz5vky1xtqs6e)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="112" x="361" y="23.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="368" y="43.8457">ActivityThread</text><rect fill="#FEFECE" filter="url(#fz5vky1xtqs6e)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="112" x="361" y="651.3887"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="368" y="671.9238">ActivityThread</text><rect fill="#FEFECE" filter="url(#fz5vky1xtqs6e)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="132" x="487" y="23.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="118" x="494" y="43.8457">VActivityManager</text><rect fill="#FEFECE" filter="url(#fz5vky1xtqs6e)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="132" x="487" y="651.3887"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="118" x="494" y="671.9238">VActivityManager</text><rect fill="#FEFECE" filter="url(#fz5vky1xtqs6e)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="62" x="633" y="23.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="48" x="640" y="43.8457">Service</text><rect fill="#FEFECE" filter="url(#fz5vky1xtqs6e)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="62" x="633" y="651.3887"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="48" x="640" y="671.9238">Service</text><rect fill="#FEFECE" filter="url(#fz5vky1xtqs6e)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="166" x="709" y="23.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="716" y="43.8457">ServiceDoneExecuting</text><rect fill="#FEFECE" filter="url(#fz5vky1xtqs6e)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="166" x="709" y="651.3887"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="716" y="671.9238">ServiceDoneExecuting</text><rect fill="#FEFECE" filter="url(#fz5vky1xtqs6e)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="180" x="889" y="23.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="166" x="896" y="43.8457">VActivityManagerService</text><rect fill="#FEFECE" filter="url(#fz5vky1xtqs6e)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="180" x="889" y="651.3887"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="166" x="896" y="671.9238">VActivityManagerService</text><rect fill="#FEFECE" filter="url(#fz5vky1xtqs6e)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="110" x="1119" y="23.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="96" x="1126" y="43.8457">ServiceRecord</text><rect fill="#FEFECE" filter="url(#fz5vky1xtqs6e)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="110" x="1119" y="651.3887"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="96" x="1126" y="671.9238">ServiceRecord</text><polygon fill="#A80036" points="114,85.7988,124,89.7988,114,93.7988,118,89.7988" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3" x2="120" y1="89.7988" y2="89.7988"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="10" y="85.3672">call(hooked)</text><polygon fill="#A80036" points="543,115.1094,553,119.1094,543,123.1094,547,119.1094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="126" x2="549" y1="119.1094" y2="119.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="133" y="114.6777">isVAServiceToken</text><polygon fill="#A80036" points="969,144.4199,979,148.4199,969,152.4199,973,148.4199" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="555" x2="975" y1="148.4199" y2="148.4199"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="562" y="143.9883">isVAServiceToken</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="981" x2="1023" y1="178.041" y2="178.041"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1023" x2="1023" y1="178.041" y2="191.041"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="982" x2="1023" y1="191.041" y2="191.041"/><polygon fill="#A80036" points="992,187.041,982,191.041,992,195.041,988,191.041" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="988" y="173.2988">boolean</text><polygon fill="#A80036" points="566,216.041,556,220.041,566,224.041,562,220.041" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="560" x2="980" y1="220.041" y2="220.041"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="572" y="215.6094">boolean</text><polygon fill="#A80036" points="137,245.3516,127,249.3516,137,253.3516,133,249.3516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="131" x2="554" y1="249.3516" y2="249.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="143" y="244.9199">boolean</text><polygon fill="#A80036" points="543,274.6621,553,278.6621,543,282.6621,547,278.6621" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="126" x2="549" y1="278.6621" y2="278.6621"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="133" y="274.2305">stopServiceToken</text><polygon fill="#A80036" points="969,303.9727,979,307.9727,969,311.9727,973,307.9727" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="555" x2="975" y1="307.9727" y2="307.9727"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="111" x="562" y="303.541">stopServiceToken</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="981" x2="1023" y1="337.5938" y2="337.5938"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1023" x2="1023" y1="337.5938" y2="350.5938"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="982" x2="1023" y1="350.5938" y2="350.5938"/><polygon fill="#A80036" points="992,346.5938,982,350.5938,992,354.5938,988,350.5938" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="129" x="988" y="332.8516">stopServiceCommon</text><polygon fill="#A80036" points="1164,375.5938,1174,379.5938,1164,383.5938,1168,379.5938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="981" x2="1170" y1="379.5938" y2="379.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="988" y="375.1621">hasAutoCreateConnections</text><polygon fill="#A80036" points="992,404.9043,982,408.9043,992,412.9043,988,408.9043" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="986" x2="1175" y1="408.9043" y2="408.9043"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="998" y="404.4727">boolean</text><polygon fill="#A80036" points="289.5,439.2148,279.5,443.2148,289.5,447.2148,285.5,443.2148" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="283.5" x2="980" y1="443.2148" y2="443.2148"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="295.5" y="438.7832">scheduleUnbindService</text><polygon fill="#FBFB77" filter="url(#fz5vky1xtqs6e)" points="8,422.2148,8,447.2148,270,447.2148,270,432.2148,260,422.2148,8,422.2148" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="260" x2="260" y1="422.2148" y2="432.2148"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="270" x2="260" y1="432.2148" y2="432.2148"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="241" x="14" y="439.7832">处理非AUTO_CREATE模式的bindService</text><polygon fill="#A80036" points="289.5,473.5254,279.5,477.5254,289.5,481.5254,285.5,477.5254" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="283.5" x2="980" y1="477.5254" y2="477.5254"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="295.5" y="473.0938">scheduleStopService</text><polygon fill="#A80036" points="407,502.8359,417,506.8359,407,510.8359,411,506.8359" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="278.5" x2="413" y1="506.8359" y2="506.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="114" x="285.5" y="502.4043">handleStopService</text><polygon fill="#A80036" points="654,532.1465,664,536.1465,654,540.1465,658,536.1465" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="419" x2="660" y1="536.1465" y2="536.1465"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="426" y="531.7148">onDestroy</text><polygon fill="#A80036" points="782,561.457,792,565.457,782,569.457,786,565.457" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3" x2="788" y1="565.457" y2="565.457"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="10" y="561.0254">call(hooked)</text><polygon fill="#A80036" points="566,590.7676,556,594.7676,566,598.7676,562,594.7676" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="560" x2="793" y1="594.7676" y2="594.7676"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="572" y="590.3359">serviceDoneExecuting</text><polygon fill="#A80036" points="969,625.0781,979,629.0781,969,633.0781,973,629.0781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="555" x2="975" y1="629.0781" y2="629.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="562" y="624.6465">serviceDoneExecuting</text><polygon fill="#FBFB77" filter="url(#fz5vky1xtqs6e)" points="986,608.0781,986,633.0781,1120,633.0781,1120,618.0781,1110,608.0781,986,608.0781" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1110" x2="1110" y1="608.0781" y2="618.0781"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1120" x2="1110" y1="618.0781" y2="618.0781"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="992" y="625.6465">移除ServiceRecord</text><!--
@startuml
box "Client Process" #LightPink
participant StopServiceToken
participant ApplicationThread
participant ActivityThread
participant VActivityManager
participant Service
participant ServiceDoneExecuting
end box

box "Server Process" #LightGreen
participant VActivityManagerService
end box

-> StopServiceToken: call(hooked)
StopServiceToken -> VActivityManager: isVAServiceToken
VActivityManager -> VActivityManagerService : isVAServiceToken
VActivityManagerService - -> VActivityManagerService: boolean
VActivityManagerService - -> VActivityManager: boolean
VActivityManager - -> StopServiceToken: boolean
StopServiceToken -> VActivityManager: stopServiceToken
VActivityManager -> VActivityManagerService : stopServiceToken
VActivityManagerService -> VActivityManagerService: stopServiceCommon
VActivityManagerService -> ServiceRecord: hasAutoCreateConnections
ServiceRecord - -> VActivityManagerService: boolean
VActivityManagerService -> ApplicationThread: scheduleUnbindService
note left
处理非AUTO_CREATE模式的bindService
end note
VActivityManagerService -> ApplicationThread: scheduleStopService
ApplicationThread -> ActivityThread: handleStopService
ActivityThread -> Service: onDestroy
-> ServiceDoneExecuting: call(hooked)
ServiceDoneExecuting -> VActivityManager: serviceDoneExecuting
VActivityManager -> VActivityManagerService: serviceDoneExecuting
note right
移除ServiceRecord
end note
@enduml

PlantUML version 1.2017.12(Thu Apr 27 00:06:36 CST 2017)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_112-release-b06
Operating System: Mac OS X
OS Version: 10.12.5
Default Encoding: UTF-8
Language: zh
Country: CN
--></g></svg>