<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="574px" preserveAspectRatio="none" style="width:1300px;height:574px;" version="1.1" viewBox="0 0 1300 574" width="1300px" zoomAndPan="magnify"><defs><filter height="300%" id="fe2kdcz8jqxy1" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#FFB6C1" height="569.6348" style="stroke: #A80036; stroke-width: 1.0;" width="894" x="51.5" y="4"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="94" x="451.5" y="16.5684">Client Process</text><rect fill="#90EE90" height="569.6348" style="stroke: #A80036; stroke-width: 1.0;" width="352" x="947.5" y="4"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="1074.5" y="16.5684">Server Process</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="103.5" x2="103.5" y1="58.7988" y2="535.1465"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="210.5" x2="210.5" y1="58.7988" y2="535.1465"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="340.5" x2="340.5" y1="58.7988" y2="535.1465"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="481.5" x2="481.5" y1="58.7988" y2="535.1465"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="617.5" x2="617.5" y1="58.7988" y2="535.1465"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="728.5" x2="728.5" y1="58.7988" y2="535.1465"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="856.5" x2="856.5" y1="58.7988" y2="535.1465"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1043.5" x2="1043.5" y1="58.7988" y2="535.1465"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1238.5" x2="1238.5" y1="58.7988" y2="535.1465"/><rect fill="#FEFECE" filter="url(#fe2kdcz8jqxy1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="55.5" y="23.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="79" x="62.5" y="43.8457">StopService</text><rect fill="#FEFECE" filter="url(#fe2kdcz8jqxy1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="55.5" y="534.1465"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="79" x="62.5" y="554.6816">StopService</text><rect fill="#FEFECE" filter="url(#fe2kdcz8jqxy1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="162.5" y="23.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="78" x="169.5" y="43.8457">VirtualCore</text><rect fill="#FEFECE" filter="url(#fe2kdcz8jqxy1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="162.5" y="534.1465"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="78" x="169.5" y="554.6816">VirtualCore</text><rect fill="#FEFECE" filter="url(#fe2kdcz8jqxy1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="141" x="268.5" y="23.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="127" x="275.5" y="43.8457">ApplicationThread</text><rect fill="#FEFECE" filter="url(#fe2kdcz8jqxy1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="141" x="268.5" y="534.1465"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="127" x="275.5" y="554.6816">ApplicationThread</text><rect fill="#FEFECE" filter="url(#fe2kdcz8jqxy1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="112" x="423.5" y="23.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="430.5" y="43.8457">ActivityThread</text><rect fill="#FEFECE" filter="url(#fe2kdcz8jqxy1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="112" x="423.5" y="534.1465"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="430.5" y="554.6816">ActivityThread</text><rect fill="#FEFECE" filter="url(#fe2kdcz8jqxy1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="132" x="549.5" y="23.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="118" x="556.5" y="43.8457">VActivityManager</text><rect fill="#FEFECE" filter="url(#fe2kdcz8jqxy1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="132" x="549.5" y="534.1465"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="118" x="556.5" y="554.6816">VActivityManager</text><rect fill="#FEFECE" filter="url(#fe2kdcz8jqxy1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="62" x="695.5" y="23.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="48" x="702.5" y="43.8457">Service</text><rect fill="#FEFECE" filter="url(#fe2kdcz8jqxy1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="62" x="695.5" y="534.1465"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="48" x="702.5" y="554.6816">Service</text><rect fill="#FEFECE" filter="url(#fe2kdcz8jqxy1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="166" x="771.5" y="23.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="778.5" y="43.8457">ServiceDoneExecuting</text><rect fill="#FEFECE" filter="url(#fe2kdcz8jqxy1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="166" x="771.5" y="534.1465"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="778.5" y="554.6816">ServiceDoneExecuting</text><rect fill="#FEFECE" filter="url(#fe2kdcz8jqxy1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="180" x="951.5" y="23.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="166" x="958.5" y="43.8457">VActivityManagerService</text><rect fill="#FEFECE" filter="url(#fe2kdcz8jqxy1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="180" x="951.5" y="534.1465"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="166" x="958.5" y="554.6816">VActivityManagerService</text><rect fill="#FEFECE" filter="url(#fe2kdcz8jqxy1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="110" x="1181.5" y="23.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="96" x="1188.5" y="43.8457">ServiceRecord</text><rect fill="#FEFECE" filter="url(#fe2kdcz8jqxy1)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="110" x="1181.5" y="534.1465"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="96" x="1188.5" y="554.6816">ServiceRecord</text><polygon fill="#A80036" points="92,85.7988,102,89.7988,92,93.7988,96,89.7988" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3" x2="98" y1="89.7988" y2="89.7988"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="10" y="85.3672">call(hooked)</text><polygon fill="#A80036" points="605.5,115.1094,615.5,119.1094,605.5,123.1094,609.5,119.1094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="104" x2="611.5" y1="119.1094" y2="119.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="111" y="114.6777">stopService</text><polygon fill="#A80036" points="1031.5,144.4199,1041.5,148.4199,1031.5,152.4199,1035.5,148.4199" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="617.5" x2="1037.5" y1="148.4199" y2="148.4199"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="624.5" y="143.9883">stopService</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1043.5" x2="1085.5" y1="178.041" y2="178.041"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1085.5" x2="1085.5" y1="178.041" y2="191.041"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1044.5" x2="1085.5" y1="191.041" y2="191.041"/><polygon fill="#A80036" points="1054.5,187.041,1044.5,191.041,1054.5,195.041,1050.5,191.041" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="1050.5" y="173.2988">findRecordLocked</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1043.5" x2="1085.5" y1="220.3516" y2="220.3516"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1085.5" x2="1085.5" y1="220.3516" y2="233.3516"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1044.5" x2="1085.5" y1="233.3516" y2="233.3516"/><polygon fill="#A80036" points="1054.5,229.3516,1044.5,233.3516,1054.5,237.3516,1050.5,233.3516" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="1050.5" y="215.6094">ServiceRecord</text><polygon fill="#A80036" points="1226.5,258.3516,1236.5,262.3516,1226.5,266.3516,1230.5,262.3516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1043.5" x2="1232.5" y1="262.3516" y2="262.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="171" x="1050.5" y="257.9199">hasAutoCreateConnections</text><polygon fill="#A80036" points="1054.5,287.6621,1044.5,291.6621,1054.5,295.6621,1050.5,291.6621" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1048.5" x2="1237.5" y1="291.6621" y2="291.6621"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="50" x="1060.5" y="287.2305">boolean</text><polygon fill="#A80036" points="352,321.9727,342,325.9727,352,329.9727,348,325.9727" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="346" x2="1042.5" y1="325.9727" y2="325.9727"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="145" x="358" y="321.541">scheduleUnbindService</text><polygon fill="#FBFB77" filter="url(#fe2kdcz8jqxy1)" points="70,304.9727,70,329.9727,332,329.9727,332,314.9727,322,304.9727,70,304.9727" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="322" x2="322" y1="304.9727" y2="314.9727"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="332" x2="322" y1="314.9727" y2="314.9727"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="241" x="76" y="322.541">处理非AUTO_CREATE模式的bindService</text><polygon fill="#A80036" points="352,356.2832,342,360.2832,352,364.2832,348,360.2832" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="346" x2="1042.5" y1="360.2832" y2="360.2832"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="358" y="355.8516">scheduleStopService</text><polygon fill="#A80036" points="469.5,385.5938,479.5,389.5938,469.5,393.5938,473.5,389.5938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="341" x2="475.5" y1="389.5938" y2="389.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="114" x="348" y="385.1621">handleStopService</text><polygon fill="#A80036" points="716.5,414.9043,726.5,418.9043,716.5,422.9043,720.5,418.9043" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="481.5" x2="722.5" y1="418.9043" y2="418.9043"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="488.5" y="414.4727">onDestroy</text><polygon fill="#A80036" points="844.5,444.2148,854.5,448.2148,844.5,452.2148,848.5,448.2148" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3" x2="850.5" y1="448.2148" y2="448.2148"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="10" y="443.7832">call(hooked)</text><polygon fill="#A80036" points="628.5,473.5254,618.5,477.5254,628.5,481.5254,624.5,477.5254" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="622.5" x2="855.5" y1="477.5254" y2="477.5254"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="634.5" y="473.0938">serviceDoneExecuting</text><polygon fill="#A80036" points="1031.5,507.8359,1041.5,511.8359,1031.5,515.8359,1035.5,511.8359" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="617.5" x2="1037.5" y1="511.8359" y2="511.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="624.5" y="507.4043">serviceDoneExecuting</text><polygon fill="#FBFB77" filter="url(#fe2kdcz8jqxy1)" points="1048,490.8359,1048,515.8359,1182,515.8359,1182,500.8359,1172,490.8359,1048,490.8359" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1172" x2="1172" y1="490.8359" y2="500.8359"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1182" x2="1172" y1="500.8359" y2="500.8359"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="1054" y="508.4043">移除ServiceRecord</text><!--
@startuml
box "Client Process" #LightPink
participant StopService
participant VirtualCore
participant ApplicationThread
participant ActivityThread
participant VActivityManager
participant Service
participant ServiceDoneExecuting
end box

box "Server Process" #LightGreen
participant VActivityManagerService
participant ServiceRecord
end box

-> StopService: call(hooked)
StopService -> VActivityManager: stopService
VActivityManager -> VActivityManagerService : stopService
VActivityManagerService -> VActivityManagerService: findRecordLocked
VActivityManagerService - -> VActivityManagerService: ServiceRecord
VActivityManagerService -> ServiceRecord: hasAutoCreateConnections
ServiceRecord - -> VActivityManagerService: boolean
VActivityManagerService -> ApplicationThread: scheduleUnbindService
note left
处理非AUTO_CREATE模式的bindService
end note
VActivityManagerService -> ApplicationThread: scheduleStopService
ApplicationThread -> ActivityThread: handleStopService
ActivityThread -> Service: onDestroy
-> ServiceDoneExecuting: call(hooked)
ServiceDoneExecuting -> VActivityManager: serviceDoneExecuting
VActivityManager -> VActivityManagerService: serviceDoneExecuting
note right
移除ServiceRecord
end note
@enduml

PlantUML version 1.2017.12(Thu Apr 27 00:06:36 CST 2017)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_112-release-b06
Operating System: Mac OS X
OS Version: 10.12.5
Default Encoding: UTF-8
Language: zh
Country: CN
--></g></svg>