<?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="466px" preserveAspectRatio="none" style="width:1164px;height:466px;" version="1.1" viewBox="0 0 1164 466" width="1164px" zoomAndPan="magnify"><defs><filter height="300%" id="f11hh7q1mrtc0r" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0"/><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0"/><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3"/><feBlend in="SourceGraphic" in2="blurOut3" mode="normal"/></filter></defs><g><rect fill="#FFB6C1" height="461.7031" style="stroke: #A80036; stroke-width: 1.0;" width="894" x="51.5" y="4"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="94" x="451.5" y="16.5684">Client Process</text><rect fill="#90EE90" height="461.7031" style="stroke: #A80036; stroke-width: 1.0;" width="192" x="947.5" y="4"/><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacingAndGlyphs" textLength="98" x="994.5" y="16.5684">Server Process</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="103.5" x2="103.5" y1="58.7988" y2="427.2148"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="210.5" x2="210.5" y1="58.7988" y2="427.2148"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="340.5" x2="340.5" y1="58.7988" y2="427.2148"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="481.5" x2="481.5" y1="58.7988" y2="427.2148"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="617.5" x2="617.5" y1="58.7988" y2="427.2148"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="728.5" x2="728.5" y1="58.7988" y2="427.2148"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="856.5" x2="856.5" y1="58.7988" y2="427.2148"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 5.0,5.0;" x1="1043.5" x2="1043.5" y1="58.7988" y2="427.2148"/><rect fill="#FEFECE" filter="url(#f11hh7q1mrtc0r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="55.5" y="23.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="79" x="62.5" y="43.8457">StopService</text><rect fill="#FEFECE" filter="url(#f11hh7q1mrtc0r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="93" x="55.5" y="426.2148"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="79" x="62.5" y="446.75">StopService</text><rect fill="#FEFECE" filter="url(#f11hh7q1mrtc0r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="162.5" y="23.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="78" x="169.5" y="43.8457">VirtualCore</text><rect fill="#FEFECE" filter="url(#f11hh7q1mrtc0r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="92" x="162.5" y="426.2148"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="78" x="169.5" y="446.75">VirtualCore</text><rect fill="#FEFECE" filter="url(#f11hh7q1mrtc0r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="141" x="268.5" y="23.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="127" x="275.5" y="43.8457">ApplicationThread</text><rect fill="#FEFECE" filter="url(#f11hh7q1mrtc0r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="141" x="268.5" y="426.2148"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="127" x="275.5" y="446.75">ApplicationThread</text><rect fill="#FEFECE" filter="url(#f11hh7q1mrtc0r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="112" x="423.5" y="23.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="430.5" y="43.8457">ActivityThread</text><rect fill="#FEFECE" filter="url(#f11hh7q1mrtc0r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="112" x="423.5" y="426.2148"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="98" x="430.5" y="446.75">ActivityThread</text><rect fill="#FEFECE" filter="url(#f11hh7q1mrtc0r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="132" x="549.5" y="23.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="118" x="556.5" y="43.8457">VActivityManager</text><rect fill="#FEFECE" filter="url(#f11hh7q1mrtc0r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="132" x="549.5" y="426.2148"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="118" x="556.5" y="446.75">VActivityManager</text><rect fill="#FEFECE" filter="url(#f11hh7q1mrtc0r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="62" x="695.5" y="23.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="48" x="702.5" y="43.8457">Service</text><rect fill="#FEFECE" filter="url(#f11hh7q1mrtc0r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="62" x="695.5" y="426.2148"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="48" x="702.5" y="446.75">Service</text><rect fill="#FEFECE" filter="url(#f11hh7q1mrtc0r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="166" x="771.5" y="23.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="778.5" y="43.8457">ServiceDoneExecuting</text><rect fill="#FEFECE" filter="url(#f11hh7q1mrtc0r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="166" x="771.5" y="426.2148"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="152" x="778.5" y="446.75">ServiceDoneExecuting</text><rect fill="#FEFECE" filter="url(#f11hh7q1mrtc0r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="180" x="951.5" y="23.3105"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="166" x="958.5" y="43.8457">VActivityManagerService</text><rect fill="#FEFECE" filter="url(#f11hh7q1mrtc0r)" height="30.4883" style="stroke: #A80036; stroke-width: 1.5;" width="180" x="951.5" y="426.2148"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacingAndGlyphs" textLength="166" x="958.5" y="446.75">VActivityManagerService</text><polygon fill="#A80036" points="92,85.7988,102,89.7988,92,93.7988,96,89.7988" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3" x2="98" y1="89.7988" y2="89.7988"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="10" y="85.3672">call(hooked)</text><polygon fill="#A80036" points="605.5,115.1094,615.5,119.1094,605.5,123.1094,609.5,119.1094" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="104" x2="611.5" y1="119.1094" y2="119.1094"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="111" y="114.6777">stopService</text><polygon fill="#A80036" points="1031.5,144.4199,1041.5,148.4199,1031.5,152.4199,1035.5,148.4199" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="617.5" x2="1037.5" y1="148.4199" y2="148.4199"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="72" x="624.5" y="143.9883">stopService</text><line style="stroke: #A80036; stroke-width: 1.0;" x1="1043.5" x2="1085.5" y1="178.041" y2="178.041"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1085.5" x2="1085.5" y1="178.041" y2="191.041"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="1044.5" x2="1085.5" y1="191.041" y2="191.041"/><polygon fill="#A80036" points="1054.5,187.041,1044.5,191.041,1054.5,195.041,1050.5,191.041" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="113" x="1050.5" y="173.2988">findRecordLocked</text><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1043.5" x2="1085.5" y1="220.3516" y2="220.3516"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1085.5" x2="1085.5" y1="220.3516" y2="233.3516"/><line style="stroke: #A80036; stroke-width: 1.0; stroke-dasharray: 2.0,2.0;" x1="1044.5" x2="1085.5" y1="233.3516" y2="233.3516"/><polygon fill="#A80036" points="1054.5,229.3516,1044.5,233.3516,1054.5,237.3516,1050.5,233.3516" style="stroke: #A80036; stroke-width: 1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="87" x="1050.5" y="215.6094">ServiceRecord</text><polygon fill="#A80036" points="352,258.3516,342,262.3516,352,266.3516,348,262.3516" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="346" x2="1042.5" y1="262.3516" y2="262.3516"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="128" x="358" y="257.9199">scheduleStopService</text><polygon fill="#A80036" points="469.5,287.6621,479.5,291.6621,469.5,295.6621,473.5,291.6621" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="341" x2="475.5" y1="291.6621" y2="291.6621"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="114" x="348" y="287.2305">handleStopService</text><polygon fill="#A80036" points="716.5,316.9727,726.5,320.9727,716.5,324.9727,720.5,320.9727" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="481.5" x2="722.5" y1="320.9727" y2="320.9727"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="65" x="488.5" y="316.541">onDestroy</text><polygon fill="#A80036" points="844.5,346.2832,854.5,350.2832,844.5,354.2832,848.5,350.2832" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="3" x2="850.5" y1="350.2832" y2="350.2832"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="77" x="10" y="345.8516">call(hooked)</text><polygon fill="#A80036" points="628.5,375.5938,618.5,379.5938,628.5,383.5938,624.5,379.5938" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="622.5" x2="855.5" y1="379.5938" y2="379.5938"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="634.5" y="375.1621">serviceDoneExecuting</text><polygon fill="#A80036" points="1031.5,404.9043,1041.5,408.9043,1031.5,412.9043,1035.5,408.9043" style="stroke: #A80036; stroke-width: 1.0;"/><line style="stroke: #A80036; stroke-width: 1.0;" x1="617.5" x2="1037.5" y1="408.9043" y2="408.9043"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacingAndGlyphs" textLength="139" x="624.5" y="404.4727">serviceDoneExecuting</text><!--
@startuml
box "Client Process" #LightPink
participant StopService
participant VirtualCore
participant ApplicationThread
participant ActivityThread
participant VActivityManager
participant Service
participant ServiceDoneExecuting
end box

box "Server Process" #LightGreen
participant VActivityManagerService
end box

-> StopService: call(hooked)
StopService -> VActivityManager: stopService
VActivityManager -> VActivityManagerService : stopService
VActivityManagerService -> VActivityManagerService: findRecordLocked
VActivityManagerService - -> VActivityManagerService: ServiceRecord
VActivityManagerService -> ApplicationThread: scheduleStopService
ApplicationThread -> ActivityThread: handleStopService
ActivityThread -> Service: onDestroy
-> ServiceDoneExecuting: call(hooked)
ServiceDoneExecuting -> VActivityManager: serviceDoneExecuting
VActivityManager -> VActivityManagerService: serviceDoneExecuting
@enduml

PlantUML version 1.2017.12(Thu Apr 27 00:06:36 CST 2017)
(GPL source distribution)
Java Runtime: OpenJDK Runtime Environment
JVM: OpenJDK 64-Bit Server VM
Java Version: 1.8.0_112-release-b06
Operating System: Mac OS X
OS Version: 10.12.5
Default Encoding: UTF-8
Language: zh
Country: CN
--></g></svg>